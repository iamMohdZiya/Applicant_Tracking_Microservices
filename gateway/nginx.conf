# --- NGINX Configuration for ATS Microservices API Gateway ---

# Defines the upstream groups for each microservice.
# In a Docker environment, these names typically match your service names
# in the docker-compose file (e.g., 'job-service').
upstream auth_service {
    server auth-service:8000;
}

upstream job_service {
    # Using default ports established in the server.js/app.js files
    server job-service:3000; 
}

upstream company_service {
    server company-service:4000;
}

upstream applicant_service {
    server applicant-service:5000;
}

# The main server block that listens for public traffic
server {
    # Nginx listens on port 80 (standard HTTP), which will be exposed publicly
    listen 80;

    # Basic performance and security settings
    client_max_body_size 10M; # Allows larger payload for applications/resumes

    # --- Job Posting Service Routing ---
    # Routes all requests starting with /api/jobs/ to the Job Service
    location /api/jobs/ {
        # Proxy the request to the upstream group
        proxy_pass http://job_service/;
        # Standard headers for passing host, IP, and protocol info
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # Prevents Nginx from adding redundant /api/jobs/ path to the service
        rewrite ^/api/jobs/(.*)$ /$1 break;
    }

    # --- Company Profile Service Routing ---
    # Routes all requests starting with /api/companies/ to the Company Service
    location /api/companies/ {
        proxy_pass http://company_service/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        rewrite ^/api/companies/(.*)$ /$1 break;
    }

    # --- Applicant Profile Service Routing ---
    # Routes all requests starting with /api/applicants/ to the Applicant Service
    location /api/applicants/ {
        proxy_pass http://applicant_service/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        rewrite ^/api/applicants/(.*)$ /$1 break;
    }

    # --- Authentication Service Routing ---
    location /api/auth/ {
        proxy_pass http://auth_service/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        rewrite ^/api/auth/(.*)$ /$1 break;
    }

    # --- Default Health Check / Root Path ---
    location / {
        return 200 'ATS Gateway is Operational\n';
        add_header Content-Type text/plain;
    }
}